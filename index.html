<!DOCTYPE html>
<html>
    <head>
        <link href="style.css" rel="stylesheet" type="text/css" />
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            *[_ox]{
                cursor:default;
                user-select: none;
                margin-bottom: 1em; 
            }
            button[_ox]:enabled{
                cursor: pointer;
            }

            .table[_ox] {
                display: table;
                border-collapse: collapse;
            }
            .row[_ox]{
                display: table-row;
            }
            .cell[_ox],.cellClick[_ox],.notClick[_ox] {
                display: table-cell;
                width: 75px;
                height: 75px;
                border: 1px solid black;
                color: transparent;
                text-align: center;
                vertical-align: middle;
            }

            #current,.player {
    
                font-size: small;
                margin-top:1em;
    
            }

            .cell.Click[_ox]{
                color:black;
            }
        </style>
        
    </head>
    <body>
        <button _ox id="start">開始</button>
        <button _ox id="reset" disabled>重置</button>
        <div _ox class="table" id="table" >
            <div _ox class="row">
                <div _ox class="cell" >O</div>
                <div _ox class="cell" >O</div>
                <div _ox class="cell" >O</div>
            </div>
            <div _ox class="row">
                <div _ox class="cell" >O</div>
                <div _ox class="cell" >O</div>
                <div _ox class="cell" >O</div>
            </div>
            <div _ox class="row">
                <div _ox class="cell" >O</div>
                <div _ox class="cell" >O</div>
                <div _ox class="cell" >O</div>
            </div>
        <div  id="current">
            目前玩家 : 
            <span id="turn">O</span>
        </div>
        <div class="player" >O : <span id="time1">60.0</span></div>
        <div class="player" >X : <span id="time2">60.0</span></div>
        <script >
            const start=document.getElementById('start'); //btn start
            const reset=document.getElementById('reset'); //btn reset
            const player=document.getElementById('turn'); //cerrent player
            const count1=document.getElementById('time1'); // countdown for O
            const count2=document.getElementById('time2'); // countdown for 1
            let cells=Array.from(document.querySelectorAll('.cell'));
            let occupied=Array.from(Array(9).keys()); //record if cells are clicked
            let currentStep = 0, //steps
                currentState = Array.from(Array(9).keys()); //record clicked cells are 0 or X
            let gameOver = true; 
            let time1=600,
                time2=600;
            let timer1 ,timer2;
            let winner=-1;


            let winninglines = {//winning condition
                line0:[0, 1, 2],
                line1:[3, 4, 5],
                line2:[6, 7, 8],
                line3:[0, 3, 6],
                line4:[1, 4, 7],
                line5:[2, 5, 8],
                line6:[0, 4, 8],
                line7:[2, 4, 6]
            };

            let getlines = { //lines need to check when click cell
                0: ['line0', 'line3', 'line6'],
                1: ['line0', 'line4'],
                2: ['line0', 'line5', 'line7'],
                3: ['line1', 'line3'],
                4: ['line1', 'line4', 'line6', 'line7'],
                5: ['line1', 'line5'],
                6: ['line2', 'line3', 'line7'],
                7: ['line2', 'line4'],
                8: ['line2', 'line5', 'line6'],
            }

            //check there is a line
            let checkline = function(a) {
                let a0 = currentState[a[0]],//check if three element are all O or X 
                    a1 = currentState[a[1]],
                    a2 = currentState[a[2]];
                let win = (a0 === a1 && a1 === a2);
                if(win) winner=a0;
                return win;
            };
            function textTimer(){
                if(currentStep%2===0) count1.innerText=String((time1/10));
                else count2.innerText=String((time2/10));
            }
            function count(){
                if(currentStep%2===0) time1--;
                else time2--;
                textTimer();
                if(time1===0 || time2===0)end();
            }
            function end(){
                textTimer();
                clearInterval(timer1);
                clearInterval(timer2);
                if(currentStep%2===1)alert('贏家是O!');
                else alert('贏家是X!');
                Endgame();
            }

            start.addEventListener('click',function(){  //click start btn
                // inital 
                gameOver = false;
                this.disabled=true;
                reset.disabled=false;
                occupied.forEach((occupy,index)=>{
                occupied[index]=false;
            });
                cells.forEach((cell,index)=>{
                    cells[index].innerText='O';
                });
                // start game
                timer1=setInterval(count,100);
                cells.forEach((cell,index)=>{ 
                    cell.addEventListener('click',()=>action(cell,index),{once:true});
                    cell.addEventListener('mouseover',function(){
                        if(!occupied[index])cell.style.color='black';});
                    cell.addEventListener('mouseout',function(){
                        if(!occupied[index])cell.style.color='transparent';});
                });
    
            },false);

                //when click the cell 
            const action=(cell,index)=>{
                if(!occupied[index] && !gameOver){
                    if(cell.innerText!=' '){
                    cell.className+=' Click';
                        occupied[index]= true;
                        if(currentStep%2 === 0){
                            player.innerText='X';
                            timer2=setInterval(count,100);
                            clearInterval(timer1);
                        }
                        else {
                            player.innerText='O';
                            timer1=setInterval(count,100);
                            clearInterval(timer2);
                        }
                        currentState[index]=currentStep%2===0?'O':'X'; //0:O ,1:X
                        currentStep ++;
                    }
                    for(let i=0;i<9;i++){
                        if(i !== index && !occupied[i]) {
                            if(cell.innerText ==='O') cells[i].innerText='X';
                            else if(cell.innerText ==='X')cells[i].innerText='O';
                        }
                    }
                    for (let i = 0, len = getlines[index].length; i < len; i++) {
                        if (checkline(winninglines[getlines[index][i]])) {
                            alert('贏家是'+cell.innerText+'!');
                            Endgame();
                            gameOver = true;
                        }
            
                    }
                    if (currentStep === 9 && winner===-1 ) {
                        gameOver = true;
                        Endgame();
                        alert('平手!');
                    }
                }
            }

            function Endgame(){
                currentStep = 0;
                for (var i = 0; i < 9; i ++) {
                    currentState[i] = null;
                }
                gameOver = true;
                clearInterval(timer1);
                clearInterval(timer2);
                winner =-1;
                cells.forEach((cell,index)=>{
                    if(!occupied[index]) cells[index].innerText=' ';
                });
            }

            reset.addEventListener('click',function(){ // click reset btn
                //reset game
                this.disabled=true;
                start.disabled=false;
                player.innerText='O';
                Endgame();
                time1=600;
                time2=600;
                count1.innerText='60.0';
                count2.innerText='60.0';

                cells.forEach((cell)=>{
                    cell.className='cell';
                    cell.innerText=' ';
                    cell.style.color='transparent';
                });
            });
        </script>
    </body>
</html>